<script>
  const WORKER_BASE = "https://rough-base-6eb1.jlucasandradeee.workers.dev";
  const ACCESS_URL = WORKER_BASE + "/access";

  // ✅ coloque aqui pra onde vai depois que liberar
  const APP_URL = "./app.html";
  // const APP_URL = "https://macropesointeligente.my.canva.site/macropesointeligente";

  function getDeviceId() {
    let id = localStorage.getItem("jf_device_id");
    if (!id) {
      id = (crypto.randomUUID ? crypto.randomUUID() : ("id-" + Math.random().toString(16).slice(2) + Date.now()));
      localStorage.setItem("jf_device_id", id);
    }
    return id;
  }

  async function doLogin() {
    const input = document.getElementById("emailInput");
    const msg = document.getElementById("msg");

    const login = (input.value || "").trim();
    if (!login) {
      msg.textContent = "Digite seu e-mail ou código.";
      msg.style.color = "#ff3b3b";
      return;
    }

    msg.textContent = "Validando acesso...";
    msg.style.color = "#ffffff";

    try {
      const r = await fetch(ACCESS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          login,
          deviceId: getDeviceId()
        })
      });

      const data = await r.json().catch(() => ({}));

      if (data && data.ok) {
        msg.textContent = "Acesso liberado. Entrando...";
        msg.style.color = "#00ff88";

        // salva login
        localStorage.setItem("jf_login", login.toLowerCase());

        // entra
        setTimeout(() => {
          window.location.href = APP_URL;
        }, 400);
        return;
      }

      // mensagens amigáveis
      const err = data?.error || "not_allowed";
      const map = {
        not_allowed: "Acesso não liberado para este login.",
        expired: "Seu acesso expirou.",
        revoked: "Acesso cancelado (reembolso/chargeback).",
        promo_expired: "Código de blogueiro expirou.",
        promo_limit_reached: "Código de blogueiro atingiu o limite de 15 acessos.",
        invalid_login: "Login inválido. Use e-mail ou código.",
        missing_login_or_device: "Erro interno (faltou login/device)."
      };

      msg.textContent = map[err] || ("Erro: " + err);
      msg.style.color = "#ff3b3b";
    } catch (e) {
      // Esse é o "Failed to fetch"
      msg.textContent = "Erro de conexão (failed to fetch). Verifique o Worker / CORS.";
      msg.style.color = "#ff3b3b";
    }
  }

  // botão
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btnEnter");
    const input = document.getElementById("emailInput");

    if (btn) btn.addEventListener("click", doLogin);

    if (input) {
      input.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") doLogin();
      });
    }
  });
</script>
